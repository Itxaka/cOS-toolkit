name: Build and publish
on:
  push:
    paths:
    - 'conf/**'
    - 'packages/**'
    - '.github/workflows/**'
    branches: [ master ]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2

    - run: |
        git fetch --prune --unshallow

    - name: setup-docker
      uses: docker-practice/actions-setup-docker@0.0.1

    # We patch docker to use all the HD available in GH action free runners
    - name: Patch Docker Daemon data-root
      run: |
        DOCKER_DATA_ROOT='/mnt/var/lib/docker'
        DOCKER_DAEMON_JSON='/etc/docker/daemon.json'
        sudo mkdir -p "${DOCKER_DATA_ROOT}"
        jq --arg dataroot "${DOCKER_DATA_ROOT}" '. + {"data-root": $dataroot}' "${DOCKER_DAEMON_JSON}" > "/tmp/docker.json.tmp"
        sudo mv "/tmp/docker.json.tmp" "${DOCKER_DAEMON_JSON}"
        sudo systemctl restart docker

    - name: Login to DockerHub Registry
      if: github.ref == 'refs/heads/master' && github.event_name == 'push'
      run: echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin

    - name: Set Push options
      if: github.ref == 'refs/heads/master' && github.event_name == 'push'
      run: echo "BUILD_ARGS=--push --only-target-package --pull" >> $GITHUB_ENV

    - name: Install deps
      run: |
        curl https://get.mocaccino.org/luet/get_luet_root.sh | sudo sh

    - name: Build packages ðŸ”§
      env:
        CLEAN: "true"
        TARGET: "target"
        SUDO: "sudo -E"
      run: |
        make rebuild-full
        ls -liah $PWD/build
    - name: Create repository ðŸ”§
      if: github.ref == 'refs/heads/master' && github.event_name == 'push'
      env:
        CLEAN: "true"
        TARGET: "target"
        SUDO: "sudo -E"
      run: |
        make create-repo
        ls -liah $PWD/build

    - name: Deploy GH Pages ðŸš€
      if: github.ref == 'refs/heads/master' && github.event_name == 'push'
      uses: JamesIves/github-pages-deploy-action@3.6.2
      with:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        BRANCH: gh-pages # The branch the action should deploy to.
        FOLDER: build # The folder the action should deploy.
        CLEAN: true # Automatically remove deleted files from the deploy branch
        SINGLE_COMMIT: true