name: Build cOS
on:
  schedule:
    - cron:  '0 20 * * *'
  push:
    paths:
    - 'conf/**'
    - 'packages/**'
    - '.github/workflows/**'
    - 'tests/**'
    - 'make/**'
    - 'Makefile'
  pull_request:
    paths:
    - 'conf/**'
    - 'packages/**'
    - 'make/**'
    - '.github/workflows/**'
    - 'Makefile'
    - 'tests/**'
  create:
    tags:
      - v*
jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
       include:
         - flavor: "opensuse"
    env:
      FLAVOR: ${{ matrix.flavor }}
    steps:
    - uses: actions/checkout@v2

    - run: |
        git fetch --prune --unshallow

    - name: setup-docker
      uses: docker-practice/actions-setup-docker@master

    # We patch docker to use all the HD available in GH action free runners
    - name: Patch Docker Daemon data-root
      run: |
        DOCKER_DATA_ROOT='/mnt/var/lib/docker'
        DOCKER_DAEMON_JSON='/etc/docker/daemon.json'
        sudo mkdir -p "${DOCKER_DATA_ROOT}"
        jq --arg dataroot "${DOCKER_DATA_ROOT}" '. + {"data-root": $dataroot}' "${DOCKER_DAEMON_JSON}" > "/tmp/docker.json.tmp"
        sudo mv "/tmp/docker.json.tmp" "${DOCKER_DAEMON_JSON}"
        sudo systemctl restart docker

    - name: Login to DockerHub Registry
      run: echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
    - name: Load Docker Content Trust
      run: |
           sudo cp -rf .github/sign-images /usr/bin/sign-images
           sudo chmod +x /usr/bin/sign-images
           PATH_KEYS=$HOME/.docker/trust/private
           USER_KEY=$PATH_KEYS/7b1922fb6fa9046a2c64c16e1e557c092699854c23dedf653fab6faac00390a5.key
           mkdir -p $PATH_KEYS
           echo "${{ secrets.DOCKER_CONTENT_TRUST_PRIVKEY }}" > $USER_KEY
           chmod 600 $USER_KEY
           export DOCKER_CONTENT_TRUST_REPOSITORY_PASSPHRASE=${{ secrets.DOCKER_CONTENT_TRUST_USER_PASSPHRASE }}
           echo "PATH_KEYS=$PATH_KEYS" >> $GITHUB_ENV
           echo "DOCKER_CONTENT_TRUST_REPOSITORY_PASSPHRASE=$DOCKER_CONTENT_TRUST_REPOSITORY_PASSPHRASE" >> $GITHUB_ENV
           echo "PUBLISH_ARGS=--plugin sign-images" >> $GITHUB_ENV
           echo $DOCKER_CONTENT_TRUST_REPOSITORY_PASSPHRASE
    - name: Upload signing logs
      uses: actions/upload-artifact@v2
      with:
        name: sign
        path: /home/runner/.docker/trust/private/7b1922fb6fa9046a2c64c16e1e557c092699854c23dedf653fab6faac00390a5.key
        if-no-files-found: warn


