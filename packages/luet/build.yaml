requires:
- name: "golang"
  category: "build"
  version: ">=0"
env:
- PATH=$PATH:/usr/local/go/bin
- GOPATH=/luetbuild/go
- GO111MODULE=off
prelude:
{{ if .Values.distribution }}
{{if eq .Values.distribution "opensuse" }}
- zypper in -y git upx
{{else if eq .Values.distribution "fedora" }}
- dnf install -y git upx
{{else if eq .Values.distribution "ubuntu" }}
# We have to add || true as system post-install of grub is broken due to efi and pc being installed together
- apt-get install -y git upx || true
{{end}}
{{end}}
- |
   PACKAGE_VERSION=${PACKAGE_VERSION%\+*} && \
   mkdir -p /luetbuild/go/src/github.com/mudler && cd /luetbuild/go/src/github.com/mudler && \
{{- if .Values.branch }}
   git clone https://github.com/mudler/luet && cd luet && git fetch --all && git checkout {{.Values.branch}} && git show
{{- else }}
   git clone https://github.com/mudler/luet && cd luet && git checkout "${PACKAGE_VERSION}" -b build
{{- end }}
steps:
- |
   PACKAGE_VERSION=${PACKAGE_VERSION%\+*} && \
   cd /luetbuild/go/src/github.com/mudler/luet && make build-small && mv luet /usr/bin/luet
includes:
- /usr/bin/luet
